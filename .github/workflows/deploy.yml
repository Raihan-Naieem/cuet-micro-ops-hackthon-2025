name: Deploy to VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}
          ssh-known-hosts: ${{ secrets.VM_KNOWN_HOSTS }}

      - name: Deploy to VM
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@36.255.71.41 << 'DEPLOY_SCRIPT'

          echo "ðŸ“‚ Setting up project directory..."
          mkdir -p /home/ubuntu/app
          cd /home/ubuntu/app

          echo "ðŸ” Checking if repo exists..."
          if [ ! -d .git ]; then
            echo "ðŸ“¥ Cloning repository..."
            git clone https://github.com/Raihan-Naieem/cuet-micro-ops-hackthon-2025.git .
          fi

          echo "ðŸ”„ Pulling latest code..."
          git fetch origin
          git checkout main
          git pull origin main

          echo "ðŸ“¦ Installing dependencies..."
          npm ci

          echo "ðŸ”¨ Building application..."
          npm run build || true

          echo "ðŸ³ Restarting Docker services..."
          docker compose -f docker/compose.prod.yml pull
          docker compose -f docker/compose.prod.yml up -d

          echo "ðŸ“‹ Checking Docker containers..."
          docker ps

          echo "â³ Waiting for services to start..."
          sleep 15

          echo "ðŸ” Checking logs..."
          docker compose -f docker/compose.prod.yml logs || true

          echo "âœ… Checking health..."
          curl -s http://localhost:3000/health || echo "Note: Could not reach localhost:3000, services may still be starting"

          echo "âœ… Deployment completed successfully!"

          DEPLOY_SCRIPT

      - name: Verify Deployment
        run: |
          echo "Waiting for app to be fully accessible..."
          sleep 10
          echo "Checking if app is running on 36.255.71.41:3000..."
          curl -s http://36.255.71.41:3000/health || echo "Warning: Health check failed (app might still be starting)"
